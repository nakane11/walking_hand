(setq *stand-pose* #f(89.6063 2.09251 -35.4375 30.5775 11.5425 74.655 -39.96 -1.07999 0.94501 85.8263 -40.4662 -35.2012 -2.19374 79.0763 -40.4662 -52.515 6.71626 74.3513 -34.83))

;; STANDING
(defvar *idle-time* 0.0)
(defvar *idle-time-period* (* 20 pi))
(defun standing-idle-frame ()
  (setq *idle-time* (mod (+ *idle-time* 1.0) *idle-time-period*))
  (let ((current-pose (copy-seq *stand-pose*))
        (pitch-amplitude 10.0) (roll-amplitude 5.0)
        (pitch-joints '(1 4 8 12 16)) (roll-joints '(3 15)))

    ;; 1. 前後揺れ (Pitch)
    (let ((offset-pitch (* pitch-amplitude (sin (* 0.2 *idle-time*)))))
      (dolist (idx pitch-joints)
        (setf (elt current-pose idx) (+ (elt *stand-pose* idx) offset-pitch))))

    ;; 2. 左右揺れ (Roll)
    (let ((inner-wave (sin (* 0.1 *idle-time*)))
          (outer-wave (sin (- (* 0.1 *idle-time*) 0.8)))) ;; 位相を遅らせる
      ;; 内側の指 (振幅は少し控えめに)
      (setf (elt current-pose 7)  (+ (elt *stand-pose* 7)  (* (* 0.5 roll-amplitude) inner-wave))) ;; MIDDLE0
      (setf (elt current-pose 11) (+ (elt *stand-pose* 11) (* (* -0.5 roll-amplitude) inner-wave))) ;; RING0 (逆位相で対称に開く)
      ;; 外側の指 (振幅は大きく、位相は遅れて)
      (setf (elt current-pose 3)  (+ (elt *stand-pose* 3)  (* roll-amplitude outer-wave)))       ;; INDEX0
      (setf (elt current-pose 15) (+ (elt *stand-pose* 15) (* (* -1.0 roll-amplitude) outer-wave)))) ;; LITTLE0 (逆位相)

    (send *ri* :angle-vector current-pose 0.1 :default-controller 0 :min-time 0.1)
    (send *ri* :wait-interpolation)
    )
  )

;; BOW
(defun play-curtsy-motion (&key (base-pose *stand-pose*) (duration 1000))
  (send *ri* :angle-vector-sequence
    (list #f(89.9438 -15.4575 6.04126 34.155 10.9013 53.1563 49.9163 -3.03749 -0.06749 64.6313 29.5988 -31.0162 1.38376 52.11 35.7413 -45.6637 8.94376 61.695 24.5025)
          #f(89.6063 -22.14 4.38751 33.8175 10.5975 52.4813 49.9163 -2.39624 -1.72124 64.9688 30.5775 -32.94 -24.03 100.136 70.2675 -46.305 -1.38374 61.695 24.84)
          #f(98.1113 -8.80874 8.94376 34.4588 42.93 33.9525 81.7425 -4.99499 26.1225 55.4513 73.6425 -36.5175 55.9238 99.1575 60.885 -39.15 14.985 73.035 36.7538))
    (list 500 400 500))
  (send *ri* :wait-interpolation)
  (unix:usleep (* duration 1000))
  (send *ri* :angle-vector-sequence
    (list #f(89.6063 -22.14 4.38751 33.8175 10.5975 52.4813 49.9163 -2.39624 -1.72124 64.9688 30.5775 -32.94 -24.03 100.136 70.2675 -46.305 -1.38374 61.695 24.84)
          #f(88.6275 -23.49 4.72501 33.8175 12.2175 53.4938 51.2325 -3.03749 -2.02499 70.1663 35.775 -31.0162 -38.34 72.8325 75.8025 -44.685 -4.79249 63.315 30.3075)
          #f(89.9438 -15.4575 6.04126 34.155 10.9013 53.1563 49.9163 -3.03749 -0.06749 64.6313 29.5988 -31.0162 1.38376 52.11 35.7413 -45.6637 8.94376 61.695 24.5025))
    (list 500 400 400))
  (send *ri* :wait-interpolation)
  )

;; STAND_WALK
(defvar *walk-next-part* :PART1)
(defvar *walk-angle-part1*
  (list
   #f(102.33 28.08 40.77 32.8388 13.5 56.4638 -89.505 17.1788 -10.2937 23.49 -50.5912 -6.17624 -16.8412 58.2863 92.745 -14.6475 -5.46749 20.25 -48.06)
   #f(102.026 27.7763 40.77 28.9575 -6.37874 58.1175 55.4513 16.2 -6.68249 23.49 -49.6125 -10.6987 -20.7562 53.9663 66.0825 -14.0062 -4.11749 20.25 -47.0475)
   #f(103.005 9.14626 6.04126 38.0363 -9.61874 83.8688 84.0375 13.9725 -13.2975 9.11251 -6.47999 -11.34 -17.5162 95.2088 93.3188 -13.6687 7.02001 -8.87624 5.80501)
   #f(100.373 20.385 39.825 19.2713 -9.61874 78.2663 93.4538 7.22251 -19.6087 0.81001 56.9025 -4.89374 -23.6925 82.6875 95.2763 -14.6475 -21.3975 39.1838 12.2513)
   ))
(defvar *walk-angle-part2*
  (list
   #f(101.689 16.5375 40.4663 28.6538 0.13501 27.0 100.946 4.01626 -8.30249 12.96 84.2738 -7.45874 -26.9662 42.525 99.7988 -19.8787 -9.51749 57.1388 12.5888)
   #f(101.351 16.8413 40.77 28.9575 -8.30249 22.68 -10.5637 5.94001 -14.9512 67.9388 95.2425 -6.47999 -23.6925 25.8188 -12.3862 -18.5625 -18.6975 76.3088 58.6575)
   #f(102.026 11.07 -1.72124 28.6538 20.7563 12.42 -18.09 6.27751 -5.02874 99.225 75.9713 -9.38249 -8.70749 10.6988 -13.3312 -27.3712 -7.15499 97.065 60.9188)
   #f(103.646 20.0475 27.135 27.3375 8.91001 27.9788 1.48501 8.50501 -18.9675 74.5538 86.94 -8.43749 -24.6712 40.9725 -2.36249 -28.35 -24.435 67.5338 71.6175)
   #f(104.963 23.5913 29.7338 28.3163 8.57251 27.675 1.14751 7.56001 -20.2837 54.4388 95.9175 -7.45874 -25.0087 39.7575 -2.69999 -27.7087 -24.0975 39.1838 71.6175)
   ))

;; SIT
(defun stand-to-sit ()
  (send *ri* :angle-vector-sequence
    (list
     #f(90.2813 -12.7912 65.4413 30.5775 6.75001 62.4375 50.5913 2.09251 -3.71249 63.99 49.7475 -32.2987 -0.57374 35.4038 67.365 -43.3687 11.475 44.7188 70.335)
     #f(81.7763 44.1113 56.0588 28.0125 7.05376 72.6638 49.9163 -4.35374 -4.01624 85.185 55.9238 -38.745 -6.74999 32.6363 65.1375 -46.98 -3.77999 39.825 69.3563)
     #f(66.4538 20.0475 51.5025 28.3163 5.46751 71.01 49.6125 -5.33249 -4.01624 82.89 54.945 -38.4412 -6.74999 33.5475 64.4625 -47.2837 -1.38374 39.825 69.9975)
     #f(68.4113 76.1738 42.7275 27.0338 27.405 91.4625 80.46 5.63626 16.1663 90.0788 73.98 -31.995 12.0825 88.29 77.76 -43.3687 17.55 91.5638 74.25)
     #f(26.055 45.3938 39.4875 33.1763 6.41251 92.1038 81.1013 5.94001 2.59876 88.425 74.9588 -27.4725 4.96126 88.965 79.38 -39.15 -2.42999 87.9863 72.9338))
    (list 500 1000 1000 500 500))
  (send *ri* :wait-interpolation))

(defun sit-to-stand ()
  (send *ri* :angle-vector-sequence
    (list
      #f(28.3163 42.525 40.1288 -2.76749 93.7913 74.655 81.1013 -2.39624 93.3525 52.515 72.63 -11.9812 109.316 72.495 76.14 -14.0062 92.4413 93.1838 71.3138)
      #f(66.7575 11.7113 52.1438 -3.07124 87.5138 71.9888 80.7975 -5.63624 97.2675 61.02 72.63 -11.9812 103.073 70.2 75.8025 -14.985 99.4275 86.3663 71.3138)
      #f(58.05 -36.5175 52.1438 -3.74624 87.8513 73.0013 80.7975 -6.61499 97.9425 70.1663 71.955 -12.285 103.073 70.2 75.8025 -16.9425 99.7313 88.3238 72.9338)
      #f(108.203 -30.8137 13.5 -4.08374 88.1888 72.6638 80.7975 -7.28999 104.153 70.8075 71.955 -12.285 103.41 69.5588 76.14 -17.2462 99.4275 90.585 71.6175)
      #f(127.136 -39.1837 56.3625 16.0313 58.1513 48.5325 81.7425 1.78876 61.4925 69.1875 71.6513 -1.95749 54.6413 84.3413 76.14 -17.2462 46.9125 95.1413 70.335)
      #f(128.79 -37.8337 56.7 20.8913 35.8425 49.5113 81.4388 -1.07999 37.0575 70.8075 71.6513 -8.09999 29.295 76.7813 75.8025 -23.7937 19.4738 83.1263 71.3138)
      #f(118.024 -12.15 37.53 33.1763 22.545 37.5975 82.08 11.4075 7.56001 62.0325 67.635 -10.6987 -0.57374 58.8938 76.7813 -29.025 -3.44249 56.4638 71.6175)
      *stand-pose*)
    (list 1000 500 500 500 500 500 500 500))
  (send *ri* :wait-interpolation))

;; ROTATE
(defvar *rotate-next-part* :PART1)
(defvar *rotate-angle-part1*
  (list
;;24あげる
   #f(87.0075 22.3088 6.68251 46.1025 -34.1212 33.2775 25.2113 -11.8462 -24.2662 59.7038 34.155 -15.8625 -27.6075 25.515 11.9138 -69.7612 -10.2262 60.3788 25.1438)
;;24移動
   #f(86.3663 28.7213 9.92251 -9.68624 -32.8387 33.615 25.8525 -15.4237 -38.2387 56.7675 39.015 -61.9987 -38.34 38.5088 15.525 -71.0775 -20.0475 62.0325 26.4263)
;;24接地
   #f(87.9863 26.46 6.98626 -8.67374 -18.36 31.32 27.5063 -14.1075 -34.2562 62.6738 39.3525 -61.6612 -22.0725 32.94 40.635 -70.0987 -24.435 62.3363 27.405)
;;回転
   #f(95.4788 25.8188 8.64001 29.9363 10.9013 7.45876 37.5638 30.3075 -2.69999 22.6463 50.7263 -21.0262 -7.72874 11.3063 69.9638 -29.3287 -18.3262 59.0963 28.3838)))
(defvar *rotate-angle-part2*
  (list
;;35あげる
   #f(100.373 39.6225 11.88 29.5988 9.92251 8.47126 36.9225 26.46 -16.6387 8.87626 28.2825 -15.525 -6.74999 21.8025 28.5863 -25.7512 -22.41 5.23126 10.665)
;;35移動
   #f(95.4788 48.9375 2.76751 25.0763 1.28251 5.80501 37.26 -16.065 -33.5812 15.12 29.5988 -18.765 -21.4312 25.515 37.6988 -52.515 -12.9262 4.59001 10.3275)
;;35接地
   #f(92.2388 54.0675 1.78876 25.4138 -3.88124 4.15126 37.5638 -19.6425 -32.265 45.63 15.6263 -19.4062 -25.65 24.6038 43.5713 -48.6 -19.035 41.7825 14.85)
;;回転
   #f(92.5425 32.265 12.8588 35.775 -4.52249 74.655 -37.6987 -14.1075 -25.9537 68.85 -7.79624 -12.6225 -29.565 78.7388 -38.205 -71.0775 -14.2762 81.1688 -25.0087)
   ))

;; GRASP
(setq *finger-names*
      (list "THUMB" "INDEX" "MIDDLE" "RING" "LITTLE"))
(defvar *finger-joint-map* (make-hash-table :test 'eq))
(dolist (pair (list (cons :THUMB (list "THUMB0" "THUMB1" "THUMB2"))
                    (cons :INDEX (list "INDEX0" "INDEX1" "INDEX2" "INDEX3"))
                    (cons :MIDDLE (list "MIDDLE0" "MIDDLE1" "MIDDLE2" "MIDDLE3"))
                    (cons :RING (list "RING0" "RING1" "RING2" "RING3"))
                    (cons :LITTLE (list "LITTLE0" "LITTLE1" "LITTLE2" "LITTLE3"))))
  (setf (gethash (car pair) *finger-joint-map*) (cdr pair)))
(defvar *target-finger* :INDEX)
(defvar *current-pose-vector* nil)
(defvar *flex-increment* 1.0)
(defvar *flex-limit* 90.0)
(defvar *servo-state-list* nil)
(defun servo-state-callback (msg)
  (setq *servo-state-list* nil)
  (dolist (servo (send msg :servos))
    (let ((name (send servo :name))
          (err (send servo :error)))
      (setq *servo-state-list* (cons (cons name err) *servo-state-list*))
      )))
(defvar *servo-subscriber* nil)
